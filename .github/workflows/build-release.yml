name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create Release'
        required: true
        default: false
        type: boolean

env:
  CREATE_RELEASE: ${{ (github.event_name == 'workflow_dispatch' && inputs.create_release == true) || startsWith(github.ref, 'refs/tags/') }}

jobs:
  build:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag: ${{ steps.get_version.outputs.tag }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Get version
      id: get_version
      shell: pwsh
      run: |
        if ($env:GITHUB_REF -like 'refs/tags/*') {
          # å·²ç”± tag æ¨é€è§¦å‘ï¼Œç›´æ¥ä½¿ç”¨è¯¥ tag ä½œä¸ºç‰ˆæœ¬
          $version = $env:GITHUB_REF.Substring(10)
          $tag = $version
        } else {
          # æ‰‹åŠ¨ workflow_dispatch è§¦å‘ï¼šä½¿ç”¨ git çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬æ’åºï¼Œé€‰å‡ºæœ€æ–° tagï¼Œç„¶åç”Ÿæˆ / é€’å¢ beta ç‰ˆæœ¬
          # --refs å¯é¿å…å‡ºç°å¸¦ ^{} çš„ peeled è¡Œï¼Œ--sort=-version:refname ä»¥ç‰ˆæœ¬åå€’åºæ’åºï¼Œ'v*' ä»…åŒ¹é…è¯­ä¹‰åŒ–ç‰ˆæœ¬å‰ç¼€
          $latestRef = git ls-remote --refs --tags --sort=-version:refname origin 'v*' |
            Where-Object { $_ -match 'refs/tags/(v\d+\.\d+\.\d+(?:-beta\.\d+)?)$' } |
            Select-Object -First 1

          if (-not $latestRef) {
            # ä»“åº“è¿˜æ²¡æœ‰ä»»ä½•ç¬¦åˆè¯­ä¹‰ç‰ˆæœ¬çš„ tagï¼Œåˆå§‹åŒ–ä¸º v0.1.0-beta.1
            $baseVersion = 'v0.1.0'
            $betaNumber = 1
            $tag = "$baseVersion-beta.$betaNumber"
          } else {
            # è¡Œæ ¼å¼: <hash>\trefs/tags/<tagname>
            if ($latestRef -match 'refs/tags/(.+)$') {
              $latestTag = $matches[1]
            } else {
              throw "æ— æ³•ä» ls-remote è¾“å‡ºä¸­è§£ææœ€æ–° tagï¼š$latestRef"
            }

            if ($latestTag -match '^(v\d+\.\d+\.\d+)-beta\.(\d+)$') {
              # æœ€æ–°å³ä¸º betaï¼Œç›´æ¥åœ¨ beta ç¼–å·ä¸Š +1
              $baseVersion = $matches[1]
              $betaNumber = [int]$matches[2] + 1
              $tag = "$baseVersion-beta.$betaNumber"
            } else {
              # æœ€æ–°ä¸ºç¨³å®šç‰ˆæœ¬ï¼Œä»è¯¥ç¨³å®šç‰ˆæœ¬å¼€å§‹æ–°çš„ beta åºåˆ—
              $latestTag -match '^(v\d+\.\d+\.)(\d+)$'
              $baseVersion = $matches[1] + ([int]$matches[2] + 1)
              $betaNumber = 1
              $tag = "$baseVersion-beta.$betaNumber"
            }
          }

          $version = $tag

          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          # åˆ›å»ºå¹¶æ¨é€æ–° beta tag
          git tag $tag
          git push origin $tag
        }

        echo "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        echo "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        echo "__version__ = '$version'" | Out-File -FilePath src/one_dragon/version.py -Encoding utf8

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11.9'

    - name: Install uv
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri https://astral.sh/uv/install.ps1 | Invoke-Expression

    - name: Create virtual environment and install dependencies
      shell: pwsh
      run: |
        uv venv .venv --python=3.11.9
        uv pip install -r requirements-dev.txt
        uv pip install -r requirements-dev-ext.txt

    - name: Download and extract UPX into venv Scripts
      shell: pwsh
      run: |
        $venvScripts = ".\.venv\Scripts"
        $upxDir = Join-Path $venvScripts "upx"
        $sourceUpxPath = Join-Path $upxDir "upx-4.2.3-win64" "upx.exe"
        $destinationUpxPath = Join-Path $venvScripts "upx.exe"
        $zipPath = "upx.zip"

        Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.2.3/upx-4.2.3-win64.zip" -OutFile $zipPath
        Expand-Archive -Path $zipPath -DestinationPath $upxDir -Force
        Move-Item -Path $sourceUpxPath -Destination $destinationUpxPath -Force
        Remove-Item -Path $upxDir -Recurse -Force
        Remove-Item -Path $zipPath -Force

    - name: Build executables
      shell: pwsh
      run: |
        .\.venv\Scripts\Activate.ps1
        cd deploy
        pyinstaller "OneDragon ScriptChainer Editor.spec"
        pyinstaller "OneDragon ScriptChainer Runner.spec"

    - name: Upload Editor
      if: ${{ env.CREATE_RELEASE == 'false' }}
      uses: actions/upload-artifact@v4
      with:
        name: Editor
        path: deploy/dist/OneDragon ScriptChainer Editor.exe

    - name: Upload Runner
      if: ${{ env.CREATE_RELEASE == 'false' }}
      uses: actions/upload-artifact@v4
      with:
        name: Runner
        path: deploy/dist/OneDragon ScriptChainer Runner.exe

    - name: Upload Dist
      if: ${{ env.CREATE_RELEASE == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: dist
        if-no-files-found: error
        path: deploy/dist

  release:
    runs-on: windows-latest
    needs: build
    if: ${{ (github.event_name == 'workflow_dispatch' && inputs.create_release == true) || startsWith(github.ref, 'refs/tags/') }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download dist
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: .

    - name: Prepare release packages
      shell: pwsh
      env:
        RELEASE_VERSION: ${{ needs.build.outputs.version }}
      run: |
        $version = $env:RELEASE_VERSION

        # åœ¨æ ¹ç›®å½•æ‰“åŒ…ä¸¤ä¸ª exe
        Compress-Archive -Path "OneDragon ScriptChainer Editor.exe","OneDragon ScriptChainer Runner.exe" -DestinationPath "OneDragon-ScriptChainer-$version.zip" -Force


    - name: Generate Changelog
      id: changelog
      shell: pwsh
      run: |
        $current_version_tag = "${{ needs.build.outputs.version }}" # ä» get_version æ­¥éª¤è·å–çš„æ ‡ç­¾
        $commits = @()

        if ($env:GITHUB_REF -like 'refs/tags/*') {
          # è¿™æ˜¯ç”±æ ‡ç­¾è§¦å‘çš„å‘å¸ƒ
          # å°è¯•æŸ¥æ‰¾å½“å‰æ ‡ç­¾æäº¤çš„çˆ¶æäº¤ä¸Šçš„æœ€æ–°æ ‡ç­¾
          $previous_tag_candidate = $(git describe --tags --abbrev=0 "$current_version_tag^" 2>$null)
          if ($previous_tag_candidate) {
            Write-Host "æ­£åœ¨ç”Ÿæˆä» $previous_tag_candidate åˆ° $current_version_tag çš„æ›´æ–°æ—¥å¿—"
            $commits = git log --pretty=format:"%s|%h" "$previous_tag_candidate..$current_version_tag"
          } else {
            Write-Host "æœªæ‰¾åˆ°ç›¸å¯¹äº $current_version_tag^ çš„ä¸Šä¸€ä¸ªæ ‡ç­¾ã€‚åˆ—å‡º $current_version_tag çš„æœ€å10ä¸ªæäº¤ã€‚"
            # è¿™å¯èƒ½æ˜¯ç¬¬ä¸€ä¸ªæ ‡ç­¾ã€‚åˆ—å‡ºå¯¼è‡´å®ƒçš„æäº¤ã€‚
            $commits = git log --pretty=format:"%s|%h" -n 10 "$current_version_tag"
          }
        } else {
          # è¿™æ˜¯æ‰‹åŠ¨ workflow_dispatch æˆ–åˆ†æ”¯æ¨é€
          Write-Host "æ‰‹åŠ¨æˆ–åˆ†æ”¯æ„å»ºã€‚åˆ—å‡º HEAD çš„æœ€å5ä¸ªæäº¤ã€‚"
          $commits = git log --pretty=format:"%s|%h" -n 5 HEAD
        }

        # æŒ‰å‰ç¼€åˆ†ç±»æäº¤
        $categories = @{
          "feat" = @()
          "fix" = @()
          "perf" = @()
          "refactor" = @()
          "style" = @()
          "docs" = @()
          "test" = @()
          "ci" = @()
          "build" = @()
          "chore" = @()
          "revert" = @()
          "other" = @()
        }

        foreach ($commit in $commits) {
          if ($commit -match "^(.+)\|(.+)$") {
            $message = $matches[1]
            $hash = $matches[2]

            # æå–å†’å·å‰çš„å‰ç¼€
            if ($message -match "^([^:]+):(.*)$") {
              $prefix = $matches[1].Trim().ToLower()
              $content = $matches[2].Trim()

              # æ£€æŸ¥å‰ç¼€æ˜¯å¦åœ¨å·²çŸ¥åˆ†ç±»ä¸­
              if ($categories.ContainsKey($prefix)) {
                $categories[$prefix] += "- $content ($hash)"
              } else {
                $categories["other"] += "- $message ($hash)"
              }
            } else {
              $categories["other"] += "- $message ($hash)"
            }
          }
        }

        # ç”Ÿæˆåˆ†ç±»åçš„æ›´æ–°æ—¥å¿—
        $changelog_content = ""
        $category_names = @{
          "feat" = "âœ¨ æ–°åŠŸèƒ½"
          "fix" = "ğŸ› Bug ä¿®å¤"
          "perf" = "âš¡ æ€§èƒ½ä¼˜åŒ–"
          "refactor" = "â™»ï¸ ä»£ç é‡æ„"
          "style" = "ğŸ’„ æ ·å¼è°ƒæ•´"
          "docs" = "ğŸ“„ æ–‡æ¡£æ›´æ–°"
          "test" = "âœ… æµ‹è¯•"
          "ci" = "ğŸ‘· CI/CD"
          "build" = "ğŸ“¦ æ„å»º"
          "chore" = "ğŸ”§ æ‚é¡¹"
          "revert" = "âª å›æ»š"
          "other" = "ğŸ“ å…¶ä»–æ›´æ”¹"
        }

        # å®šä¹‰è¾“å‡ºé¡ºåº
        $ordered_keys = @("feat", "fix", "perf", "refactor", "style", "docs", "test", "ci", "build", "chore", "revert", "other")

        foreach ($key in $ordered_keys) {
          if ($categories[$key].Count -gt 0) {
            if ($changelog_content -ne "") {
              $changelog_content += "`n`n"
            }
            $changelog_content += "## $($category_names[$key])`n"
            $changelog_content += ($categories[$key] -join "`n")
          }
        }

        if ([string]::IsNullOrWhiteSpace($changelog_content)) {
          $changelog_content = "æ²¡æœ‰æ–°çš„æ›´æ”¹æˆ–æ— æ³•ç¡®å®šæ›´æ–°æ—¥å¿—ã€‚"
        }

        $output_name = "clean_changelog"
        $delimiter = "CHANGELOG_DELIMITER_$(New-Guid)"

        echo "$output_name<<$delimiter" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        echo $changelog_content | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        echo $delimiter | Out-File -FilePath $env:GITHUB_OUTPUT -Append

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.build.outputs.tag }}
        name: "Release ${{ needs.build.outputs.version }}"
        body: |
          ## OneDragon ScriptChainer ${{ needs.build.outputs.version }}

          ### ä¸‹è½½è¯´æ˜

          - `OneDragon-ScriptChainer-${{ needs.build.outputs.version }}.zip` - åŒ…å«ç¼–è¾‘å™¨å’Œè¿è¡Œå™¨çš„å®Œæ•´åŒ…

          ### ä½¿ç”¨æ–¹æ³•

          1. ä¸‹è½½ `OneDragon-ScriptChainer-${{ needs.build.outputs.version }}.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `OneDragon ScriptChainer Editor.exe` åˆ›å»ºå’Œç¼–è¾‘è„šæœ¬é“¾
          4. è¿è¡Œ `OneDragon ScriptChainer Runner.exe` æ‰§è¡Œè„šæœ¬é“¾

          [æ›´å¤šå‚è€ƒ](https://one-dragon.com/tools/zh/script_chainer.html)

          # æ›´æ–°å†…å®¹

          ${{ steps.changelog.outputs.clean_changelog }}

        files: |
          OneDragon-ScriptChainer-${{ needs.build.outputs.version }}.zip
        generate_release_notes: false
        prerelease: ${{ contains(needs.build.outputs.version, '-beta.') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
